var Ye=Object.defineProperty;var Ue=(a,t,e)=>t in a?Ye(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var ye=(a,t,e)=>Ue(a,typeof t!="symbol"?t+"":t,e);import"../chunks/Bg9kRutz.js";import"../chunks/69_IOA4Y.js";import{f as xe,g as we,i as ke,k as s,C as p,s as V,j as F,r as N,t as q,l as Ie,av as I,m as X,ao as Ke,aT as qe}from"../chunks/Bebrl_GB.js";import{s as Y,d as Me,e as fe,r as Je}from"../chunks/DAZUbNIE.js";import{e as ie,i as he}from"../chunks/DHR4ypr7.js";import{c as Fe,a as L,t as $,b as Te}from"../chunks/DL1Yrt72.js";import{s as Re,t as de}from"../chunks/A4ys3QME.js";import{t as Ne,s as Ge,a as Be,b as Oe}from"../chunks/CLXnKHEh.js";import{p as C}from"../chunks/DfSpLhxt.js";import{b as ze}from"../chunks/vTheh8S9.js";import{i as se}from"../chunks/BFzG-UlA.js";import{s as Ee,a as Ze,r as Qe}from"../chunks/CTjveqIR.js";import{p as ne,r as Xe}from"../chunks/CZnWLyqJ.js";import{b as Le}from"../chunks/DXDjW1TS.js";import{o as et,a as tt}from"../chunks/maO4LbFL.js";function ve(a,t,e){let r=t;r=r.replace(/(\w+)\s+d(\d+)/g,(l,n,c)=>{const o=a.numbers[n],v=o?Math.floor(o.value):1,y=parseInt(c);let k=0;for(let w=0;w<v;w++)k+=Math.floor(Math.random()*y)+1;return k.toString()});for(const[l,n]of Object.entries(a.numbers)){const c=Math.floor(n.value);r=r.replace(new RegExp(`\\b${l}\\b`,"g"),c.toString())}r=r.replace(/(\d+)d(\d+)(?:k([hl])(\d+))?/g,(l,n,c,o,v)=>{if(e!=null&&e.noDice)return"0";const y=parseInt(n),k=parseInt(c),w=v?parseInt(v):y,T=[];for(let i=0;i<y;i++)T.push(Math.floor(Math.random()*k)+1);return o==="h"?(T.sort((i,u)=>u-i),T.slice(0,w).reduce((i,u)=>i+u,0).toString()):o==="l"?(T.sort((i,u)=>i-u),T.slice(0,w).reduce((i,u)=>i+u,0).toString()):T.reduce((i,u)=>i+u,0).toString()}),r=r.replace(/\bd(\d+)\b/g,(l,n)=>{if(e!=null&&e.noDice)return"0";const c=parseInt(n);return(Math.floor(Math.random()*c)+1).toString()});try{if(/[a-zA-Z_]/.test(r))return console.warn(`Unresolved variables in expression: ${r}`),NaN;const l=Function(`"use strict"; return (${r})`)();return Math.floor(l)}catch(l){return console.error(`Failed to evaluate dice expression: ${t} -> ${r}`,l),NaN}}function at(a,t){let e=t;e=e.replace(/(\w+)\s+d(\d+)/g,(c,o,v)=>{const y=a.numbers[o],k=y?Math.floor(y.value):1,w=parseInt(v);let T=0;for(let i=0;i<k*2;i++)T+=Math.floor(Math.random()*w)+1;return T.toString()});for(const[c,o]of Object.entries(a.numbers)){const v=Math.floor(o.value);e=e.replace(new RegExp(`\\b${c}\\b`,"g"),v.toString())}let r=0,l=e;l=l.replace(/(\d+)d(\d+)(?:k([hl])(\d+))?/g,(c,o,v,y,k)=>{const w=parseInt(o),T=parseInt(v),i=k?parseInt(k):w,u=[];for(let m=0;m<w*2;m++)u.push(Math.floor(Math.random()*T)+1);let _=0;return y==="h"?(u.sort((m,b)=>b-m),_=u.slice(0,i*2).reduce((m,b)=>m+b,0)):y==="l"?(u.sort((m,b)=>m-b),_=u.slice(0,i*2).reduce((m,b)=>m+b,0)):_=u.reduce((m,b)=>m+b,0),r+=_,"0"}),l=l.replace(/\bd(\d+)\b/g,(c,o)=>{const v=parseInt(o),y=Math.floor(Math.random()*v)+1,k=Math.floor(Math.random()*v)+1;return r+=y+k,"0"});let n=0;try{/[a-zA-Z_]/.test(l)?console.warn(`Unresolved variables in critical damage expression: ${l}`):n=Function(`"use strict"; return (${l})`)()}catch(c){console.error(`Failed to evaluate bonus expression: ${l}`,c)}return Math.floor(r+n)}function De(a,t){if(!a)return{damageDealt:0,damageType:"damage"};let e=a.trim();const r=e.split(/\s+/);let l="damage";const n=["+","-","*","/","(",")"],c=Object.keys(t.numbers);let o=r.length;for(let y=r.length-1;y>=0;y--){const k=r[y];if(n.includes(k)||!isNaN(Number(k))||/\d*d\d+/.test(k)||c.includes(k))break;o=y}return o<r.length&&o>0&&(l=r.slice(o).join(" "),e=r.slice(0,o).join(" ")),e.trim()||(e=a,l="damage"),{damageDealt:ve(t,e),damageType:l}}function st(a,t,e,r){var b;const l=e.roll.startsWith("+");let n=0,c=0,o=0;if(l){c=Math.floor(Math.random()*20)+1;const j=e.roll.substring(1);o=ve(a,j),console.log(a,j,o),n=c+o}else n=ve(a,e.roll);let v="roll",y=!1,k=!1,w=!1,T;t&&e.roll_against!==void 0&&(T=isNaN(Number(e.roll_against))?((b=t.numbers[e.roll_against])==null?void 0:b.value)||0:Number(e.roll_against)),l?c===20?(y=!0,w=!0):c===1?(k=!0,w=!1):t&&T?w=n>=T:w=!0:t&&T?w=n>=T:w=!0;let i={damageDealt:0,damageType:"damage"},u={damageDealt:0,damageType:"damage"};if(y){const j=De(e.hit,a);i.damageType=j.damageType,i.damageDealt=at(a,e.hit.replace(j.damageType,"").trim())}else i=De(e.hit,a);e.miss==="half"?u={damageDealt:Math.floor(i.damageDealt/2),damageType:i.damageType}:u=De(e.miss,a);let _=`${a.name} ${e.name.toLowerCase()}${e.name[e.name.length-1]==="s"?"es":"s"}${t!==void 0?` ${t.name}`:""}:`;l?_+=` ${c} ${o>=0?"+":"-"} ${Math.abs(o)}`:_+=` ${n}`;let m=e.roll;return e.roll_against&&(_+=` vs ${T??e.roll_against}`,m+=` vs ${e.roll_against}`),e.roll_against?y?(v="critical-hit",_+=` | ${i.damageDealt} ${i.damageType}`,m+=` | CRITICAL 2x ${e.hit}`):w?(_+=` | ${i.damageDealt} ${i.damageType}`,m+=` | ${e.hit}`):(_+=` | ${u.damageDealt} ${u.damageType}`,m+=` | ${e.miss}`,v=k?"critical-miss":"miss"):(_+=` | Hit: ${i.damageDealt} ${i.damageType} | Miss: ${u.damageDealt} ${u.damageType}`,m+=` | Hit: ${e.hit}, Miss: ${e.miss}`),r(_+"           "+m,v),w?i:u}function je(a,t){let e="";t[0]==="-"&&(e="-",t=t.substring(1));const r={};for(const[i,u]of Object.entries(a.numbers))r[i]=Math.floor(u.value),u.name!==i&&(r[u.name.toLowerCase()]=Math.floor(u.value));const l=t.split(/(\s+|[+\-])/),n=[],c=[];for(let i=0;i<l.length;i++){const u=l[i];u&&!u.match(/^\s+$/)&&!u.match(/^[+\-]$/)?n.push(u):u&&c.push(u)}const o=n.map(i=>{const u=i.toLowerCase();return r.hasOwnProperty(u)?r[u].toString():i}),v=[],y=[];let k=0,w=0;for(;k<o.length;){const i=o[k];if(/^\d+$/.test(i)){let u=parseInt(i,10),_=k+1,m=w;for(;_<o.length&&/^\d+$/.test(o[_]);){const b=parseInt(o[_],10);let j="+";for(;m<c.length;){const R=c[m];if(R.match(/^[+\-]$/)){j=R,m++;break}m++}j==="-"?u-=b:u+=b,_++}for(v.push(u.toString());w<c.length&&w<m;)w++;k=_}else v.push(i),w<c.length&&(y.push(c[w]),w++),k++}let T=v[0]||"";for(let i=1;i<v.length;i++)i-1<y.length&&(T+=y[i-1]),T+=v[i];return`${e}${T}`}function rt(a){const t=a-1;return t*t*t+1}function it(a){return--a*a*a*a*a+1}var nt=$('<div class="tooltip-type-badge svelte-1jrc5a8"> </div>'),ot=$('<span class="tooltip-type-badge svelte-1jrc5a8"> </span>'),lt=$('<div role="tooltip" aria-live="polite"><div class="tooltip-glow svelte-1jrc5a8"></div> <div class="tooltip-content svelte-1jrc5a8"><h3 class="tooltip-title svelte-1jrc5a8"> </h3> <p class="tooltip-description svelte-1jrc5a8"> </p> <div class="tooltip-chips svelte-1jrc5a8"><!> <!></div></div> <div class="tooltip-border svelte-1jrc5a8"></div></div>');function ct(a,t){xe(t,!0);let e=ne(t,"visible",15,!1),r=ne(t,"content",31,()=>C({name:"",description:"",type:"feature",chips:[]})),l=I(void 0),n=I(null),c=I(!1);const o=0;function v(_){s(n)&&clearTimeout(s(n)),p(n,C(setTimeout(()=>{r(_),e(!0)},o))),p(c,!1)}function y(){e(!1),s(n)&&(clearTimeout(s(n)),p(n,null))}function k(_){p(c,C(_))}function w(_){switch(_){case"feature":return"gradient-feature";case"character":return"gradient-character";case"skill":return"gradient-skill";case"item":return"gradient-item";default:return"gradient-default"}}var T=Fe(),i=we(T);{var u=_=>{var m=lt(),b=V(F(m),2),j=F(b),R=F(j,!0);N(j);var U=V(j,2),z=F(U,!0);N(U);var P=V(U,2),H=F(P);{var J=d=>{var D=nt(),O=F(D,!0);N(D),q(()=>Y(O,r().type)),L(d,D)};se(H,d=>{r().type!=="attack"&&d(J)})}var Z=V(H,2);ie(Z,17,()=>r().chips,he,(d,D)=>{var O=ot(),g=F(O,!0);N(O),q(()=>Y(g,s(D))),L(d,O)}),N(P),N(b),Ie(2),N(m),ze(m,d=>p(l,d),()=>s(l)),q(d=>{Re(m,`global-tooltip ${d??""} ${(s(c)?"shaking":"")??""} svelte-1jrc5a8`),Y(R,r().name),Y(z,r().description)},[()=>w(r().type)]),Ne(1,m,()=>Ge,()=>({duration:300,easing:it,start:.8})),L(_,m)};se(i,_=>{e()&&_(u)})}return L(a,T),ke({show:v,hide:y,setShaking:k})}var ut=(a,t,e)=>{if(t()===void 0)return;let r=a.shiftKey;e.onAttackTargetSelected(e.character,r)},dt=(a,t,e,r)=>{var l;t(void 0),e({}),(l=r.tooltip)==null||l.hide(),a.preventDefault()},ht=$('<div class="multiplier-indicator svelte-kfumgr"> </div>'),ft=(a,t,e,r)=>t(20,e.character.name,s(r).name.replaceAll("_"," "),Math.floor(e.character.numbers[s(r).name].value)),pt=(a,t,e,r)=>{t(20,e.character.name,s(r).replaceAll("_"," "),Math.floor(e.character.numbers[s(r)].value)),a.preventDefault()},mt=$('<div class="child-stat svelte-kfumgr"><div class="child-label svelte-kfumgr"> </div> <div class="child-value svelte-kfumgr"> </div></div>'),vt=$('<div class="stat-children svelte-kfumgr"></div>'),gt=$('<div class="stat-parent svelte-kfumgr"><div class="stat-item svelte-kfumgr"><div class="stat-label svelte-kfumgr"> </div> <div class="stat-value svelte-kfumgr"> </div></div> <!></div>'),bt=$('<div class="stats-row svelte-kfumgr"></div>'),yt=(a,t,e,r)=>t(e(),r().substring(0,r().length-1)),_t=(a,t,e)=>{t(e(),a)},wt=$('<div class="feature-item svelte-kfumgr"> </div>'),xt=(a,t,e)=>t(e(),"attack"),kt=(a,t,e)=>{t(e(),a)},St=$('<div class="attack-item feature-item svelte-kfumgr"> </div>'),Tt=$('<div class="feature-list svelte-kfumgr"><div class="feature-type svelte-kfumgr"> </div> <!></div>'),Dt=$('<div class="features svelte-kfumgr"></div>'),Nt=$("<!> <!>",1),At=$('<div class="character-card svelte-kfumgr"><!> <div class="character-name svelte-kfumgr"> </div> <div class="health-bar svelte-kfumgr"><div class="health-fill svelte-kfumgr"></div> <input type="text" class="health-input svelte-kfumgr"></div> <!></div>');function Ct(a,t){xe(t,!0);let e=ne(t,"selectedAttack",15,void 0),r=ne(t,"selectedAttackTargets",31,()=>C({})),l=X(()=>t.character.numbers.max_hp.value),n=X(()=>t.character.numbers.damage.value),c=X(()=>Math.max(0,s(l)-s(n))),o=X(()=>s(c)/s(l)*100),v=X(()=>{var d;return((d=r()[t.character.index])==null?void 0:d.timesAttacked)||0}),y=X(()=>Object.entries(t.character.features));function k(d,D,O,g){const A=Math.floor(Math.random()*d)+1,h=A+(g||0);let S="roll";A===20?S="critical-hit":A===1&&(S="critical-miss");const M=`${D} rolled ${O}: d20(${A}) + ${g} = ${h}`;t.logMessage(M,S)}let w=X(()=>(()=>{let d={},D=[],O={};function g(h){if(h.name==="max_hp"||h.name==="damage")return;let S={name:h.name,stat:h,children:[]};h.parentName===""&&(O[h.name]=S),h.row!==void 0?(d[h.row]||(d[h.row]=[]),d[h.row].push(S)):D.push(S)}for(const[h,S]of Object.entries(t.character.numbers))g(S);function A(h){for(let S=0;S<h.length;S++){let M=h[S];M.stat.parentName!==""&&(O.hasOwnProperty(M.stat.parentName)?(O[M.stat.parentName].children.push(M.name),h.splice(S--,1)):M.name=M.stat.parentName)}}for(const[h,S]of Object.entries(d))A(S);return A(D),[...Object.values(d),D]})());function T(d){if(d.key==="Enter"){const D=d.target.value.trim();if(!D)return;let O;if(D.startsWith("+")){const g=parseFloat(D.substring(1));O=s(n)-g}else if(D.startsWith("-")){const g=parseFloat(D.substring(1));O=s(n)+g}else{const g=parseFloat(D);O=s(l)-g}t.updateCharacterHealth(t.character,O),d.target.value=""}}function i(d,D){var O;if(D.preventDefault(),D.stopImmediatePropagation(),d.roll_against!==""){e({attacker:t.character,attack:d}),(O=t.tooltip)==null||O.setShaking(!0);return}if(d.roll){const g=d.roll.startsWith("+");let A="",h=0,S=0;if(g){h=Math.floor(Math.random()*20)+1;const K=d.roll.substring(1);S=ve(t.character,K),A=`${h} + ${S} = ${h+S}`}else A=`${ve(t.character,d.roll)}`;let M="roll";h===20&&(M="critical-hit"),h===1&&(M="critical-miss"),t.logMessage(`${t.character.name} rolled ${d.name}: ${A}           ${d.roll}`,M)}}function u(d,D="feature"){t.tooltip!==void 0&&(["skill","feature","attack","item"].includes(D)||(D="feature"),t.tooltip.show({name:d.name,description:d.description,type:D,chips:d.chips}))}function _(){t.tooltip&&t.tooltip.hide()}var m=At();m.__click=[ut,e,t],m.__contextmenu=[dt,e,r,t];var b=F(m);{var j=d=>{var D=ht(),O=F(D);N(D),q(()=>Y(O,`x${s(v)??""}`)),L(d,D)};se(b,d=>{s(v)>1&&d(j)})}var R=V(b,2),U=F(R,!0);N(R);var z=V(R,2),P=F(z),H=V(P,2);H.__keydown=T,N(z);var J=V(z,2);{var Z=d=>{var D=Nt(),O=we(D);ie(O,17,()=>s(w),he,(h,S)=>{var M=bt();ie(M,21,()=>s(S),he,(K,G)=>{var te=gt(),ee=F(te);ee.__click=[ft,k,t,G];var Q=F(ee),oe=F(Q,!0);N(Q);var ce=V(Q,2),pe=F(ce,!0);N(ce),N(ee);var ge=V(ee,2);{var W=ae=>{var re=vt();ie(re,21,()=>s(G).children,he,(be,f)=>{var x=mt();x.__click=[pt,k,t,f];var E=F(x),B=F(E,!0);N(E);var me=V(E,2),le=F(me,!0);N(me),N(x),q((ue,He)=>{Y(B,ue),Y(le,He)},[()=>s(f).replaceAll("_"," "),()=>Math.floor(t.character.numbers[s(f)].value)]),L(be,x)}),N(re),L(ae,re)};se(ge,ae=>{s(G).children.length>0&&ae(W)})}N(te),q((ae,re)=>{Y(oe,ae),Y(pe,re)},[()=>s(G).name.replaceAll("_"," "),()=>Math.floor(t.character.numbers[s(G).name].value)]),L(K,te)}),N(M),L(h,M)});var g=V(O,2);{var A=h=>{var S=Dt();ie(S,21,()=>s(y),he,(M,K)=>{let G=()=>s(K)[0],te=()=>s(K)[1];var ee=Tt(),Q=F(ee),oe=F(Q,!0);N(Q);var ce=V(Q,2);ie(ce,17,()=>Object.entries(te()),he,(pe,ge)=>{let W=()=>s(ge)[1];var ae=Fe(),re=we(ae);{var be=x=>{var E=wt();E.__mouseover=[yt,u,W,G],E.__click=[_t,i,W];var B=F(E,!0);N(E),q(()=>Y(B,W().name)),fe("mouseleave",E,_),L(x,E)},f=x=>{var E=St();E.__mouseover=[xt,u,W],E.__click=[kt,i,W];var B=F(E,!0);N(E),q(()=>Y(B,W().name)),fe("mouseleave",E,_),L(x,E)};se(re,x=>{W().roll_against===""?x(be):x(f,!1)})}L(pe,ae)}),N(ee),q(()=>Y(oe,G())),L(M,ee)}),N(S),L(h,S)};se(g,h=>{s(y).length>0&&h(A)})}L(d,D)};se(J,d=>{e()===void 0&&d(Z)})}N(m),q(d=>{de(m,"selected-for-attack",s(v)!==0),Y(U,t.character.name),Ee(P,"style",`width: ${s(o)??""}%`),Ee(H,"placeholder",`${d??""}/${s(l)??""}`)},[()=>Math.floor(s(c))]),fe("mouseenter",m,()=>{var d;return(d=t.onCharacterHover)==null?void 0:d.call(t,t.character)}),fe("mouseleave",m,()=>{var d;return(d=t.onCharacterHover)==null?void 0:d.call(t,void 0)}),L(a,m),ke()}Me(["click","contextmenu","keydown","mouseover"]);function Mt(a,{from:t,to:e},r={}){var{delay:l=0,duration:n=P=>Math.sqrt(P)*120,easing:c=rt}=r,o=getComputedStyle(a),v=o.transform==="none"?"":o.transform,[y,k]=o.transformOrigin.split(" ").map(parseFloat);y/=a.clientWidth,k/=a.clientHeight;var w=Ft(a),T=a.clientWidth/e.width/w,i=a.clientHeight/e.height/w,u=t.left+t.width*y,_=t.top+t.height*k,m=e.left+e.width*y,b=e.top+e.height*k,j=(u-m)*T,R=(_-b)*i,U=t.width/e.width,z=t.height/e.height;return{delay:l,duration:typeof n=="function"?n(Math.sqrt(j*j+R*R)):n,easing:c,css:(P,H)=>{var J=H*j,Z=H*R,d=P+H*U,D=P+H*z;return`transform: ${v} translate(${J}px, ${Z}px) scale(${d}, ${D});`}}}function Ft(a){if("currentCSSZoom"in a)return a.currentCSSZoom;for(var t=a,e=1;t!==null;)e*=+getComputedStyle(t).zoom,t=t.parentElement;return e}function Ot(a,t,e){!s(t)&&s(e).includes("developers/apps")&&window.open("https://www.dropbox.com/developers/apps/","_blank")}function Et(a,t,e){p(t,C(a.target.value)),e()}var Lt=$('<div class="dropbox-controls svelte-ra14sz"><div class="token-row svelte-ra14sz"><input type="text" placeholder="Paste Dropbox access token to enable sync..." class="token-input svelte-ra14sz"></div></div>'),jt=$('<div class="dropbox-textarea-container svelte-ra14sz"><textarea></textarea> <!> <div class="sync-status svelte-ra14sz"><!></div></div>');function Pt(a,t){xe(t,!0);let e=ne(t,"value",15,""),r=ne(t,"placeholder",3,"Enter your text here..."),l=ne(t,"storageKey",3,"persistent-textarea"),n=ne(t,"storagePrefix",3,"svelte-persistent-"),c=ne(t,"class",3,""),o=Xe(t,["$$slots","$$events","$$legacy","value","placeholder","storageKey","storagePrefix","class"]);const v=n()+l(),y="svelte-persistent-dropbox-token";let k=I(C(e())),w=I(!1),T=I(!1),i=I(null),u=I(""),_=I(null),m=I(null),b=I("Not connected - visit https://www.dropbox.com/developers/apps/ and paste your app's access token"),j=X(()=>s(u)===""),R=X(()=>s(_)!==null),U=I(null),z=I(null),P=I(!1),H=I(C(Date.now())),J=I(!1),Z=I(null),d=I("");const D=`/${v}`;function O(f){e(f),p(k,C(f))}function g(){p(H,C(Date.now())),p(J,!0),s(Z)&&clearTimeout(s(Z)),p(Z,C(setTimeout(()=>{p(J,!1)},2e3)))}et(async()=>{try{const f=localStorage.getItem(v);f!==null&&O(f)}catch(f){console.warn("Failed to load from localStorage:",f)}try{const f=localStorage.getItem(y);f&&p(u,C(f))}catch(f){console.warn("Failed to load access token from localStorage:",f)}typeof window<"u"&&!window.Dropbox&&await A(),p(w,!0),s(u)&&!s(i)&&h()}),tt(()=>{s(_)&&clearTimeout(s(_)),s(Z)&&clearTimeout(s(Z)),s(U)&&s(U).abort()});async function A(){return new Promise((f,x)=>{const E=document.createElement("script");E.src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js",E.onload=f,E.onerror=x,document.head.appendChild(E)})}async function h(){if(!s(u).trim()){p(b,"Please enter access token");return}p(b,"Connecting...");try{p(i,C(new window.Dropbox.Dropbox({accessToken:s(u).trim()})));const f=await s(i).usersGetCurrentAccount();p(b,`Connected as ${f.result.name.display_name}`);try{localStorage.setItem(y,s(u).trim())}catch(x){console.warn("Failed to save token to localStorage:",x)}await S(),K()}catch(f){console.error("Dropbox connection failed:",f),p(b,"Connection failed - clearing token");try{localStorage.removeItem(y)}catch(x){console.warn("Failed to clear token from localStorage:",x)}p(i,null),p(u,""),setTimeout(()=>{p(b,"Not connected - visit https://www.dropbox.com/developers/apps/ and paste your app's access token")},3e3)}}async function S(){if(s(i))try{const f=await s(i).filesListFolder({path:"",recursive:!1,include_deleted:!1});p(z,C(f.result.cursor)),f.result.entries.find(E=>E.path_lower===D.toLowerCase())?await M():(p(b,"File not found in Dropbox, will create on next save"),p(T,!0))}catch(f){console.error("Failed to initialize from Dropbox:",f),p(b,"Initialization error")}}async function M(){if(!(!s(i)||s(R)))try{const x=await(await s(i).filesDownload({path:D})).result.fileBlob.text();if(!s(T))O(x),p(d,C(x)),p(m,C(new Date)),p(b,`Loaded from Dropbox (${s(m).toLocaleTimeString()})`),p(T,!0);else if(x!==e()){if(x===s(d)){p(m,C(new Date)),p(b,`Confirmed save (${s(m).toLocaleTimeString()})`);return}s(J)||Date.now()-s(H)<3e3?p(b,"Remote changes detected (waiting for typing to finish)"):(console.log("🔄 Textarea content overwritten by external update"),console.log("📝 Previous local content:",e()),console.log("📥 New external content:",x),console.log('⚠️  If this was a mistake, copy the "Previous local content" above'),O(x),p(d,C(x)),p(m,C(new Date)),p(b,`Updated from Dropbox (${s(m).toLocaleTimeString()})`))}else p(m,C(new Date)),p(b,`No changes since (${s(m).toLocaleTimeString()})`)}catch(f){f.status===409?(p(b,"File not found in Dropbox, will create on next save"),p(T,!0)):(console.error("Failed to load from Dropbox:",f),p(b,"Sync error (load)"))}}async function K(){if(!(!s(i)||!s(z)||s(P))){for(p(P,!0);s(i)&&s(z)&&s(P);)try{if(s(U)&&s(U).abort(),p(U,C(new AbortController)),(await s(i).filesListFolderLongpoll({cursor:s(z),timeout:30})).result.changes){const x=await s(i).filesListFolderContinue({cursor:s(z)});p(z,C(x.result.cursor)),x.result.entries.some(B=>B.path_lower===D.toLowerCase()&&B[".tag"]!=="deleted")&&await M()}await new Promise(x=>setTimeout(x,100))}catch(f){if(f.name==="AbortError")break;console.error("Long polling error:",f),await new Promise(x=>setTimeout(x,5e3));try{const x=await s(i).filesListFolder({path:"",recursive:!1,include_deleted:!1});p(z,C(x.result.cursor))}catch(x){console.error("Failed to reinitialize cursor:",x);break}}p(P,!1)}}async function G(){if(p(_,null),!!s(T)&&s(i))try{await s(i).filesUpload({path:D,contents:e(),mode:"overwrite",autorename:!1}),p(d,C(e())),p(m,C(new Date)),p(b,`Saved to Dropbox (${s(m).toLocaleTimeString()})`);try{const f=await s(i).filesListFolder({path:"",recursive:!1,include_deleted:!1});p(z,C(f.result.cursor))}catch(f){console.warn("Failed to update cursor after save:",f)}s(P)||K()}catch(f){console.error("Failed to save to Dropbox:",f),p(b,"Sync error (save)")}}function te(){e()!==s(k)&&(p(k,C(e())),s(_)&&clearTimeout(s(_)),p(_,C(setTimeout(async()=>{s(i)&&await G()},750))))}function ee(f){g(),e(f.target.value)}Ke(()=>{if(s(w)){if(s(k)===e())return;try{localStorage.setItem(v,e())}catch(f){console.warn("Failed to save to localStorage:",f)}s(i)&&te()}});var Q=jt(),oe=F(Q);Je(oe);let ce;var pe=V(oe,2);{var ge=f=>{var x=Lt(),E=F(x),B=F(E);Qe(B),B.__input=[Et,u,h],N(E),N(x),Le(B,()=>s(u),me=>p(u,me)),L(f,x)};se(pe,f=>{s(j)&&f(ge)})}var W=V(pe,2);W.__click=[Ot,i,b];var ae=F(W);{var re=f=>{var x=Te();q(()=>Y(x,`Saving in 1s... | ${s(b)??""}`)),L(f,x)},be=f=>{var x=Fe(),E=we(x);{var B=le=>{var ue=Te();q(()=>Y(ue,`Typing... | ${s(b)??""}`)),L(le,ue)},me=le=>{var ue=Te();q(()=>Y(ue,`${s(b)??""} ${(s(P)?"(watching for changes)":"")??""}`)),L(le,ue)};se(E,le=>{s(J)?le(B):le(me,!1)},!0)}L(f,x)};se(ae,f=>{s(R)?f(re):f(be,!1)})}N(W),N(Q),q((f,x)=>{ce=Ze(oe,ce,{placeholder:r(),class:c(),oninput:ee,...o},"svelte-ra14sz"),de(W,"connected",s(i)),de(W,"error",f),de(W,"debouncing",s(R)),de(W,"typing",s(J)),de(W,"longpolling",s(P)),de(W,"clickable",x)},[()=>s(b).includes("error"),()=>!s(i)&&s(b).includes("developers/apps")]),Le(oe,e),L(a,Q),ke()}Me(["input","click"]);function It(a){const t=Rt(a.replaceAll("\\","\\\\"));try{return JSON.parse(t)}catch(e){let r=`JSON parsing failed: ${e.message}
Normalized JSON:
${t}
Original:
${a}`;throw console.log(r),new Error(r)}}class We{constructor(t){ye(this,"input");ye(this,"pos");ye(this,"keyLineNumbers");this.input=this.removeTrailingCommas(t),this.pos=0,this.keyLineNumbers={}}removeTrailingCommas(t){return t.replace(/,(\s*[}\]])/g,"$1")}getCurrentLineNumber(){let t=0;for(let e=0;e<this.pos;e++)this.input[e]===`
`&&t++;return t}skipWhitespace(){for(;this.pos<this.input.length&&/[\s]/.test(this.input[this.pos]);)this.pos++}peek(){return this.input[this.pos]||""}advance(){return this.input[this.pos++]||""}parseString(){if(this.peek()==='"'){this.advance();let t="";for(;this.pos<this.input.length&&this.peek()!=='"';)if(this.peek()==="\\"){this.advance();const e=this.advance();switch(e){case"n":t+=`
`;break;case"t":t+="	";break;case"r":t+="\r";break;case"\\":t+="\\";break;case'"':t+='"';break;default:t+=e;break}}else t+=this.advance();return this.advance(),t}else{let t="";for(;this.pos<this.input.length;){const e=this.peek();if(e===","||e==="}"||e==="]"||e===":")break;t+=this.advance()}return t.trim()}}parseNumber(){let t="";for(this.peek()==="-"&&(t+=this.advance());this.pos<this.input.length&&/[\d.]/.test(this.peek());)t+=this.advance();return parseFloat(t)}parseValue(){this.skipWhitespace();const t=this.peek();if(t==="{")return this.parseObject();if(t==="[")return this.parseArray();if(t==='"')return this.parseString();if(t==="t"&&this.input.substr(this.pos,4)==="true")return this.pos+=4,!0;if(t==="f"&&this.input.substr(this.pos,5)==="false")return this.pos+=5,!1;if(t==="n"&&this.input.substr(this.pos,4)==="null")return this.pos+=4,null;if(t==="-"||/\d/.test(t)){const e=this.pos,r=this.parseNumber();this.skipWhitespace();const l=this.peek();return(l===","||l==="}"||l==="]"||l===""||/\s/.test(l))&&!isNaN(r)?r:(this.pos=e,this.parseString())}else return this.parseString()}parseObject(){const t={};if(this.advance(),this.skipWhitespace(),this.peek()==="}")return this.advance(),t;let e=0;for(;this.pos<this.input.length;){this.skipWhitespace();const r=this.getCurrentLineNumber();this.pos;let l=!1,n=this.pos,c=0,o=0,v=0,y=!1;if(this.skipWhitespace(),this.peek()==='"'){let i=this.pos+1,u=!1;for(;i<this.input.length;){const m=this.input[i];if(u)u=!1;else if(m==="\\")u=!0;else if(m==='"'){i++;break}i++}let _=i;for(;_<this.input.length&&/\s/.test(this.input[_]);)_++;_<this.input.length&&this.input[_]===":"&&(l=!0)}else{n=this.pos;const i=1e3;for(;n<this.input.length&&n-this.pos<i;){const u=this.input[n];if(u==='"'&&(n===0||this.input[n-1]!=="\\"))y=!y;else if(!y)if(u==="(")c++;else if(u===")")c--;else if(u==="{")o++;else if(u==="}")o--;else if(u==="[")v++;else if(u==="]")v--;else if(u===":"&&c===0&&o===0&&v===0){l=!0;break}else{if(u===","&&c===0&&o===0&&v===0)break;if(u==="}"&&c===0&&o===0&&v===0)break}n++}}let w,T;if(l){if(w=this.parseString(),this.keyLineNumbers[w]=r,this.skipWhitespace(),this.peek()!==":"){let i=this.pos,u=this.input;throw new Error(`Expected ':' after key "${w}" at position ${i}. ${u.substring(i-10,i)} ... ${u.substring(i,i+20)}`)}this.advance(),this.skipWhitespace(),T=this.parseValue()}else w=e.toString(),this.keyLineNumbers[w]=r,e++,T=this.parseValue();if(t[w]=T,this.skipWhitespace(),this.peek()==="}"){this.advance();break}else if(this.peek()===","){if(this.advance(),this.skipWhitespace(),this.peek()==="}"){this.advance();break}}else throw new Error(`Expected ',' or '}' at position ${this.pos}, instead got "${this.peek()}", context ${this.input.substring(this.pos-10,this.pos+10)}`)}return t}parseArray(){const t=[];if(this.advance(),this.skipWhitespace(),this.peek()==="]")return this.advance(),t;for(;this.pos<this.input.length;){this.skipWhitespace();const e=this.parseValue();if(t.push(e),this.skipWhitespace(),this.peek()==="]"){this.advance();break}else if(this.peek()===","){if(this.advance(),this.skipWhitespace(),this.peek()==="]"){this.advance();break}}else{let r=`Expected ',' or ']' at position ${this.pos}, instead got "${this.peek()}", context ${this.input.substring(this.pos-10,this.pos+10)}`;throw new Error(r)}}return t}parse(){try{return this.pos=0,this.skipWhitespace(),{success:!0,data:this.parseValue()}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown parsing error"}}}getKeyLineNumbers(){return{...this.keyLineNumbers}}}function Ae(a,t=0){const e=" ".repeat(t),r=" ".repeat(t+1);if(a===null)return"null";if(typeof a=="boolean"||typeof a=="number")return a.toString();if(typeof a=="string")return`"${a.replace(/"/g,'\\"')}"`;if(Array.isArray(a))return a.length===0?"[]":`[${a.map(n=>Ae(n,t+1)).join(", ")}]`;if(typeof a=="object"){const l=Object.keys(a);return l.length===0?`{
 
}`:`{
${l.map(c=>{const o=Ae(a[c],t+1);return`${r}"${c}": ${o}`}).join(`,
`)}
${e}}`}return"null"}function Rt(a){const e=new We(a).parse();return e.success?Ae(e.data):(console.log("Failed to parse",a,e),"")}function zt(a){const t=new We(a);if(t.parse().success)return t.getKeyLineNumbers();throw new Error("Failed to parse JSON for line number extraction")}function Se(a){const t=a.split("/");return t.length===1?{parent:"",name:a.trim()}:{parent:t[0].trim(),name:t[1].trim()}}function Wt(a){const t=[];for(let e=0;e<a.length;e++){const r=a[e].trim();if(!r)continue;const l=Vt(r,e);l&&t.push(l)}return t}function Vt(a,t){let e;try{const n=`{ ${a} }`;if(e=It(n),!e.name)return}catch(n){console.error(`Parsing error: ${n.message} in character ${a}`);return}const r={name:e.name,index:t,originalText:a,numbers:{},features:{}};for(const[n,c]of Object.entries(e)){if(n==="name")continue;const o=Ce(n);let v=c.toString();$t(c)?Ve(r,o,v):typeof c=="object"&&c!==null&&Ht(r,n,c)}if(!r.numbers.hasOwnProperty("max_hp")||!r.numbers.hasOwnProperty("damage"))return;Kt(r),Jt(r),Yt(r);let l=zt(`{${r.originalText}}`);for(const[n,c]of Object.entries(l)){let{name:o}=Se(n);o=Ce(o),r.numbers[o]!==void 0&&(r.numbers[o].row=c)}return r}function Ce(a){return a.trim().replace(/\s+/g,"_")}function $t(a){return typeof a=="number"||typeof a=="string"&&/^[0-9\s+\-*\/().a-zA-Z_]+$/.test(a)}function Ve(a,t,e){let r=Number(e);const{parent:l,name:n}=Se(t);a.numbers[n]={name:n,parentName:l,baseValue:e,modifiers:[],value:r}}function Ht(a,t,e){const{parent:r,name:l}=Se(t);let n=0;for(n=0;e[n];n++);e.description===void 0&&(e.description=e[--n]||"");let c=["hit","roll"];for(let k=0;k<n;k++){for(;c.length>0&&e[c[c.length-1]]!==void 0;)c.pop();let w=c.pop();w!==void 0&&(e[w]=e[k])}let[o,v]=Ut(e.roll||""),y={name:l,description:e.description||"",roll:o,roll_against:v,hit:e.hit||"",miss:e.miss||"",hit_effect:e.hitEffect||"",miss_effect:e.missEffect||"",stats:Array.isArray(e.stats)?e.stats:[],chips:Array.isArray(e.chips)?e.chips:[]};a.features[r]||(a.features[r]=[]),a.features[r].push(y)}function Yt(a){for(const t of Object.values(a.features))for(const e of t){if(e.roll&&e.roll!=="0")if(e.roll_against!==""){let r=ve(a,e.roll,{noDice:!0});e.chips.push(`${r>=0?"+":""}${r} vs ${e.roll_against}`)}else e.chips.push(`${e.roll}`);e.hit&&e.chips.push(je(a,e.hit)),e.miss==="half"?e.chips.push("save half"):e.miss&&e.chips.push(`(${je(a,e.miss)} on save)`)}}function Ut(a){let t=a.split(" vs ");return[t[0],t[1]||""]}function Kt(a){for(const t of Object.values(a.features))for(const e of t)if(e.stats)for(const r of e.stats)qt(a,e,r)}function $e(a){const t=a.split("=");if(t.length!==2)return console.log(`cannot apply modifier "${a}" - should have single = existing - must be of the form STAT [+-*/]= EXPRESSION`),{parent:"",stat:"",operator:"+",expression:"",prefix:""};const[e,r]=t,l=e.substring(e.length-1);if(!["+","-","*","/"].includes(l))return console.log(`cannot apply modifier "${a}" - wrong operator - must be of the form STAT [+-*/]= EXPRESSION`),{parent:"",stat:"",operator:"+",expression:"",prefix:""};const n=e.substring(0,e.length-1),c=Ce(n),{parent:o,name:v}=Se(c);return{parent:o,stat:v,operator:l,expression:r,prefix:c}}function qt(a,t,e){let{stat:r,prefix:l}=$e(e);a.numbers[r]||Ve(a,l,"0"),a.numbers[r].modifiers.push({source:t,modifier:e})}function Jt(a){let e=0;for(;e<100;){let r=!1;for(const[l,n]of Object.entries(a.numbers)){const c=n.value,o=Gt(n,a.numbers);o!==c&&!isNaN(o)&&(n.value=o,r=!0)}if(!r)break;e++}}function Gt(a,t){let e=a.baseValue,r=Pe(e,t);if(isNaN(r))return NaN;for(const{modifier:l}of a.modifiers){let{operator:n,expression:c}=$e(l);const o=Pe(c,t);if(isNaN(o))return NaN;n==="+"&&(r+=o),n==="-"&&(r-=o),n==="*"&&(r*=o),n==="/"&&(r/=o)}return r}function Pe(a,t){if(typeof a=="number")return a;let e=a.toString();for(const[r,l]of Object.entries(t)){const n=new RegExp(`\\b${r}\\b`,"g");e=e.replace(n,Math.floor(l.value).toString())}if(/[a-zA-Z]/.test(e))return NaN;try{return Function(`"use strict"; return (${e})`)()}catch{return NaN}}let _e=C({value:`
name: "Luke, Elf Fighter",

level: 3, ac: 10+dex, hit_die: 10, level/pb: (level + 3) / 4 + 1, level/used_hit_dice: 0, level/cantrip_dice: 1+(level+1)/6,
str: 2, dex: 2, con: 1.5, int: -1, wis: 0, cha: 0,

max hp: level * (hit_die/2 + 1 + con) + hit_die/2 - 1, damage: 0,
str/str save: str, dex/dex save: dex, con/con save: con, int/int save: int, wis/wis save: wis, cha/cha save: cha,
int/history: int, wis/perception: wis, cha/persuasion: cha,

features / Elf: { You have advantage against charm effects, stats: [int += 0.5, dex += 1, wis/perception += pb] },
features / Trance: { "As an elf, you need rest only 4 hours in quiet meditation to gain the benefits of long rest." },
features / Position of Privilege: { "Thanks to your noble birth, people are inclined to think the best of you. You are welcome in high society, and people assume you have the right to be wherever you are. The common folk make every effort to accommodate you and avoid your displeasure, and other people of high birth treat you as a member of the same social sphere. You can secure an audience with a local noble if you need to.", stats: [int/history += pb, cha/persuasion += pb] },

items / Longsword +1: { +1+str+pb vs ac , d10+1+str slashing , "Sap - Your hit enemy has disadvantage on their next attack this round." },
spells / Fireball: { d20 + int + pb - 14 vs dex_save , 8d6 fire , miss: half , "Range: 150 feet.", chips: [30🏹]},
cantrips / Firebolt: { +pb+int vs ac , cantrip_dice d10 fire , "You hurl a mote of flame up to 120 feet at your foe.", chips: [24🏹] },

items / Chainmail: { stats: [ac += 6 - dex], "The wearer has disadvantage on Dexterity (Stealth) checks." },
items / Healing Potion: { 0 vs 0, -2d4-2 , "This small potion heals the most mortal of wounds, but little else?" },
---
name: "Sylas, Human Rogue",

level: 3, ac: 10+dex, hit_die: 8,
level/pb: (level + 3) / 4 + 1, level/used_hit_dice: 0, level/cantrip_dice: 1+(level+1)/6, str: 0, dex: 3, con: 1, int: 1, wis: 1, cha: 0,

max hp: level * (hit_die/2 + 1 + con) + hit_die/2 - 1, damage: 0, str/str save: str, dex/dex save: dex + pb, con/con save: con, int/int save: int, wis/wis save: wis, cha/cha save: cha, dex/acrobatics: dex + pb, dex/stealth: dex + pb, int/investigation: int + pb, wis/perception: wis + pb,

features / Human: { "Versatile and ambitious, you gain proficiency in one skill of your choice.", stats: [dex/stealth += pb] },
features / Sneak Attack: { +dex+pb vs ac, d6+dex + 2d6 piercing, "Once per turn, you deal an extra 2d6 damage when you hit with a finesse or ranged weapon and have advantage or an ally within 5 feet of the target." }, features / Assassinate: { "You have advantage on attack rolls against any creature that hasn’t taken a turn in combat yet. Any hit you score against a surprised creature is a critical hit." },

items / Shortsword: { +dex+pb vs ac, d6+dex piercing, "Finesse weapon, eligible for Sneak Attack." },
items / Dagger: { +dex+pb vs ac, d4+dex piercing, "Finesse, light, thrown (range 20/60)." },
items / Leather Armor: { stats: [ac += 1], "Light armor, allows full Dexterity bonus to AC." },
items / Thieves' Tools: { +dex+pb, "Used for picking locks and disarming traps." },

cantrips / Minor Illusion: { +int+pb-14 vs int_save, 0 illusion, "You create a sound or image of an object within 30 feet that lasts for 1 minute." },
---
--- name: mook 1, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 2, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 3, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 4, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 5, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 6, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 7, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 8, max hp: 100, damage: 3, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 9, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
--- name: mook 10, max hp: 100, damage: 0, ac: 12, ac/str_save: 2, ac/dex_save: 0, ac/con_save: 0, ac/int_save: -1, ac/wis_save: 0, ac/cha_save: 0
`}),Bt=`
You must convert the above into a character sheet of the following format:
\`\`\`
---
name: "Luke, Elf Fighter",

level: 3, ac: 10+dex, hit_die: 10, level/pb: (level + 3) / 4 + 1, level/used_hit_dice: 0, level/cantrip_dice: 1+(level+1)/6,
str: 2, dex: 2, con: 1.5, int: -1, wis: 0, cha: 0,

max hp: level * (hit_die/2 + 1 + con) + hit_die/2 - 1, damage: 0,
str/str save: str, dex/dex save: dex, con/con save: con, int/int save: int, wis/wis save: wis, cha/cha save: cha,
int/history: int, wis/perception: wis, cha/persuasion: cha,

features / Elf: { You have advantage against charm effects, stats: [int += 0.5, dex += 1, wis/perception += pb] },
features / Trance: { "As an elf, you need rest only 4 hours in quiet meditation to gain the benefits of long rest." },
features / Position of Privilege: { "Thanks to your noble birth, people are inclined to think the best of you. You are welcome in high society, and people assume you have the right to be wherever you are. The common folk make every effort to accommodate you and avoid your displeasure, and other people of high birth treat you as a member of the same social sphere. You can secure an audience with a local noble if you need to.", stats: [int/history += pb, cha/persuasion += pb] },

items / Longsword +1: { +1+str+pb vs ac , d10+1+str slashing , "Sap - Your hit enemy has disadvantage on their next attack this round." },
spells / Fireball: { d20 + int + pb - 14 vs dex_save , 8d6 fire , miss: half , "Range: 150 feet." },
cantrips / Firebolt: { +pb+int vs ac , cantrip_dice d10 fire , "You hurl a mote of flame up to 120 feet at your foe." },

items / Chainmail: { stats: [ac += 6 - dex], "The wearer has disadvantage on Dexterity (Stealth) checks." },
items / Healing Potion: { 0 vs 0, -2d4-2 , "This small potion heals the most mortal of wounds, but little else?" },
---
\`\`\`
The entire expression is surrounded by braces and parsed as a json object, where quotes are not mandatory.
Variables are defined by simply adding a key and a simple expression which can contain other variables. For example, any character's hit points in D&D can be expressed as "level * (hit_die/2 + 1 + con) + hit_die/2 - 1".
However, if a player rolled hit points, this will not be an accurate number. Use your best judgement for different cases you may encounter.

In addition, character features can be provided, which can be attacks or generic features. Special rendering is done for groups of "items", "skills", "features", so those should be preferred choices.
A feature is a
[group name /] feature name: {
	name: string;
	description: string;
	roll: string;
	hit: string;
	miss: string;
	hit_effect: string;
	miss_effect: string;
	stats: string[];
	chips: string[];
}

A feature may modify stats, for example being an elf gives +1 dex and +0.5 to another stat. A feat gives +0.5 to some stat. Use this instead of modifying the base value, so that the source of changes can be determined.

Attacks have a roll: and must be of the form "(expression) vs (stat)"
For 5e D&D, (stat) should be one of [ac, str_save, dex_save, con_save, int_save, wis_save, cha_save]
When an attack targets a save, you can convert between a save DC and an attack bonus by subtracting 22 and targeting the targets saving throw bonus.
This means that a save attack could use (d20+save_dc-22) or (d20+pb+stat-14) as its bonus
For an attack that cannot score a critical hit - anything targeting saves, (expression) is "d20 + BONUS"
For an attack that can score a critical hit, (expression) is "+BONUS". Spells that make attack rolls, or most weapons, use this.
For an attack that automatically hits, use "0 vs 0" for the roll. For an attack that has a 40% percent chance to work, "d20 vs 8" works.
BONUS is a calculation containing numbers (like a +1 magic weapon) and stats (like a proficiency bonus, pb, and relevant stats)

hit and miss are the amounts of damage to deal on a hit or missed attack. They are not run together.
miss may be "half" which just means to halve the damage a hit would deal.
Some examples follow:
items / Longbow: {roll: +pb+dex vs ac, hit: 1d8+dex piercing, chips: [🏹30/120], description: "A longbow is a large, hand-drawn bow, typically made of wood, with long, nearly straight limbs that form an arc when strung."}
spells / Scorching Rays: {roll: +pb+int vs ac, hit: 2d6 fire, chips: [🏹24], description: "You create three rays of fire and hurl them at targets within range. You can hurl them at one target or several."}
spells / Fireball: {roll: d20+pb+int-14 vs dex_save, hit: 8d6 fire, miss: half, chips: [🏹30, 4◎] description: "A bright streak flashes from your pointing finger to a point you choose within range and then blossoms with a low roar into an explosion of flame. Each creature in a 20-foot-radius sphere centered on that point must make a Dexterity saving throw. A target takes 8d6 fire damage on a failed save, or half as much damage on a successful one. The fire spreads around corners. It ignites flammable objects in the area that aren’t being worn or carried."}
spells / Finger of Death (2e conversion): {roll: d20+pb+int vs con_save, hit_effect: Killed instantly, miss: 2d8+1 necrotic, description: "The caster utters the finger of death spell incantation, points his index finger at the creature to be slain, and unless the victim succeeds in a saving throw vs. spell, death occurs. A creature successfully saving still receives 2d8+1 points of damage. If the subject dies of damage, no internal changes occur and the victim can then be revived normally."}
spells / Charm Person: {roll: d20+pb+int vs wis_save, hit_effect: Charmed, chips: [🅒 1🕯, 🏹6], description: "You attempt to charm a humanoid you can see within range. It must make a Wisdom saving throw, and does so with advantage if you or your companions are fighting it. If it fails the saving throw, it is charmed by you until the spell ends or until you or your companions do anything harmful to it. The charmed creature regards you as a friendly acquaintance. When the spell ends, the creature knows it was charmed by you."}
spells / Shield: {chips: [⤵], description: "When you are hit by an attack or targeted by magic missile, an invisible barrier of magical force appears and protects you. Until the start of your next turn, you have a +5 bonus to AC, including against the triggering attack, and you take no damage from magic missile."}
spells / Misty Step: {chips: [◆, 🏹6], description: "Briefly surrounded by silvery mist, you teleport up to 30 feet to an unoccupied space that you can see."}
spells / Magic Missile: {roll: 0 vs 0, chips: [🏹24], hit: 1d4+1, description: "You create three glowing darts of magical force. Each dart hits a creature of your choice that you can see within range. A dart deals 1d4+1 force damage to its target. The darts all strike simultaneously and you can direct them to hit one creature or several."}
	
For spells that allow you to make multiple attacks, such as scorching ray or magic missile, just write the effects of one attack.
	
You may add chips to features. These should be used to indicate an action's action cost, range, duration, etc
Full action: ◆◆
Bonus action: ◆
Reaction: ⤵
Duration: 100⌛
Range: 🏹
Radius: ◎
Concentration: 🅒
Cast Time: (if longer than one action) "10 minute casting"

You should set the base scores to their modifiers. For example, an Intelligence of 12 means int: 2, and a Constitution of 17 means con: 3.5
	
Helpful shorthand notation:
◆◆           This spell costs a bonus action to cast
◆            This spell costs a bonus action to cast
◇            This spell costs a free action to cast
⤵            This spell costs a reaction to cast
1🧊           5 foot cube
4◎            20 foot radius
3┅            15 foot line
8🏹            40 foot range
🅒             Concentration spell, roll CON save. Taking more than that much damage or ◇ ends spell
1⌛            1 round
1🕯            1 hour
🏕              Long rest
Circle         Spell level
`;function Zt(a){if(a.length===0)return[];let t=[[a[0]]];for(let r=1;r<a.length;r++){let l=function(k){return Object.keys(k.features).length>1},n=a[r],c=t[t.length-1],o=l(n),v=l(c[c.length-1]),y=!1;y||(y=o&&!v),y||(y=!o&&v),y||(y=o&&c.length>1),y?t.push([a[r]]):t[t.length-1].push(a[r])}let e=[];for(let r=0;r<t.length;r++){if(t[r].length>5)for(;t[r].length>5;){let l=Math.ceil(t[r].length/5),n=Math.ceil(t[r].length/l);e.push(t[r].splice(0,n))}t[r].length!==0&&e.push(t[r])}return e}var Qt=()=>navigator.clipboard.writeText(Bt),Xt=$('<div class="template-row svelte-1mywl1"></div>'),ea=$('<div style="white-space: pre;"> </div>'),ta=$('<main class="svelte-1mywl1"><div class="textarea-always svelte-1mywl1"><div class="textarea-container svelte-1mywl1"><!> <span class="help-icon svelte-1mywl1">?</span></div></div> <div class="characters-container svelte-1mywl1"><div id="charactersDisplay" class="svelte-1mywl1"><!> <div class="last-padding svelte-1mywl1"></div></div></div> <div class="log-container svelte-1mywl1"><div id="logDisplay" class="svelte-1mywl1"></div></div> <!></main>');function aa(a,t){xe(t,!0);let e=C([]),r=X(()=>[...e].reverse()),l=X(()=>_e.value.split("---")),n=X(()=>Wt(s(l))),c=I(void 0),o=I(C({})),v=I(void 0);function y(g){const A=g.key;if(s(v))if(A>="1"&&A<="9"){const h=parseInt(A);s(o)[s(v).index]={character:s(v),timesAttacked:h}}else A=="0"?s(v)&&delete s(o)[s(v).index]:g.key==="Enter"&&_()}function k(g){if(s(c)!==void 0)return y(g)}function w(g){p(v,C(g))}function T(g,A){A=Math.max(0,Math.min(g.numbers.max_hp.value,A));let h=s(l)[g.index],S="damage:",M=h.indexOf(S);if(M===-1&&(S='"damage":',M=h.indexOf(S)),M===-1)return;let G=h.slice(M+S.length).match(/-?\d+(\.\d+)?/);if(!G)return;let te=M+S.length+G.index,ee=te+G[0].length,Q=h.slice(0,te)+A.toString()+h.slice(ee);s(l)[g.index]=Q,_e.value=s(l).join("---")}function i(g,A){let h=s(r)[0],S=new Date;h!=null&&h.timestamp&&S.getTime()-h.timestamp.getTime()>2e3&&e.push({message:"",type:"roll",timestamp:void 0,key:e.length}),e.push({message:g,type:A,timestamp:S,key:e.length})}let u=X(()=>Zt(s(n)));function _(){var g;if(s(c)!==void 0){for(const[A,h]of Object.entries(s(o))){let S=0;for(let M=0;M<h.timesAttacked;M++){let K=st(s(c).attacker,h.character,s(c).attack,i);S+=K.damageDealt}T(h.character,h.character.numbers.damage.value+S)}p(c,void 0),p(o,C({})),(g=s(b))==null||g.hide()}}function m(g,A){s(c)!==void 0&&(A?s(o).hasOwnProperty(g.index)?delete s(o)[g.index]:s(o)[g.index]={character:g,timesAttacked:1}:(s(o).hasOwnProperty(g.index)||(s(o)[g.index]={character:g,timesAttacked:1}),_()))}let b=I(void 0);var j=ta();fe("keydown",qe,k);var R=F(j),U=F(R),z=F(U);Pt(z,{placeholder:"Enter character JSON here...",get value(){return _e.value},set value(g){_e.value=g}});var P=V(z,2);P.__click=[Qt],N(U),N(R);var H=V(R,2),J=F(H),Z=F(J);ie(Z,17,()=>s(u),he,(g,A)=>{var h=Xt();ie(h,21,()=>s(A),S=>S.index,(S,M)=>{Ct(S,{get character(){return s(M)},get tooltip(){return s(b)},logMessage:i,updateCharacterHealth:T,onAttackTargetSelected:m,onCharacterHover:w,get selectedAttack(){return s(c)},set selectedAttack(K){p(c,C(K))},get selectedAttackTargets(){return s(o)},set selectedAttackTargets(K){p(o,C(K))}})}),N(h),L(g,h)}),Ie(2),N(J),N(H);var d=V(H,2),D=F(d);ie(D,29,()=>s(r),g=>g.key,(g,A)=>{var h=ea(),S=F(h,!0);N(h),q(M=>{Re(h,`log-entry ${s(A).type??""} svelte-1mywl1`),Y(S,M)},[()=>`${s(A).timestamp?s(A).timestamp.toLocaleTimeString():""}     ${s(A).message}`]),Ne(1,h,()=>Oe,()=>({y:-24,duration:250})),Ne(2,h,()=>Oe,()=>({y:24,duration:250})),Be(h,()=>Mt,()=>({duration:100})),L(g,h)}),N(D),N(d);var O=V(d,2);ze(ct(O,{}),g=>p(b,C(g)),()=>s(b)),N(j),fe("mouseenter",P,()=>{var g;return(g=s(b))==null?void 0:g.show({name:"Help",description:"Click to copy llm instructions on how to create your character sheet. Take any format, copy paste it into claude.ai, and click this icon and copy paste the contents to her also.",type:"info",chips:[]})}),fe("mouseleave",P,()=>{var g;return(g=s(b))==null?void 0:g.hide()}),L(a,j),ke()}Me(["click"]);function ya(a){aa(a,{})}export{ya as component};
